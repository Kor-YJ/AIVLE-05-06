<!DOCTYPE html>
<!-- 증상 검색 페이지 -->
<!-- {% load static %} -->
<html lang="ko">
<head>
    <title> KIOSK </title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../static/style.css">
    <script src="../static/hangul.js" type="text/javascript"></script>
    <script src="../static/keyboard.js" type="text/javascript"></script>
    <script src="../static/auth.js"></script>
</head>
<body>
    {% include 'header.html' %}
    <input type='hidden' value='{{patient_id}}' id='patient_id'/>
    <div class="res-wrap">
        <p id="res-input-text">진료 받기 원하시는 과를 고르시거나<br>아픈 부위나 증상을 입력해주세요</p>
        <input type="text" id="res-input" placeholder="소화기내과" />
        <button type="button" id="res-find-btn" onclick="moveDoctor()">검 색</button>
        <div class="btns-wrap">
            {% for depart in departments %}
                <button class="search-button" id="res-chs-btn" data-depart="{{ depart.id }}">{{ depart.departments_name }}</button>
            {% if forloop.counter|divisibleby:4 and not forloop.last %}
        </div>
        <div class="btns-wrap">
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div id="keyboard-div"></div>
    <footer role="contentinfo" onclick="moveChat()">
        <div class="footer_wrap">
            <img src="../images/bot_image.png" id="bot_img"><div class="footer_block">저를 누르면 음성으로 대화 가능해요<br>무엇이든 물어보세요!</div>
        </div>
    </footer>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    function moveDoctor(){
        location.href = "doctor_list.html";
    }
    function moveChat(){
        location.href = "chat.html";
    }

    $(document).ready(function() {
        $('#myForm').submit(function(event) {
            // 기본 제출 동작 방지
            event.preventDefault();

            // form 데이터 가져오기
            var formData = $(this).serialize();

            $.ajax({
                url: '/disease/search_disease/',  // 검색을 처리할 Django 뷰의 URL
                type: 'GET',
                data: formData,
                success: function(response) {
                    $('#search-results').html(response);  // 검색 결과를 표시할 요소에 결과를 채웁니다
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        var buttons = document.querySelectorAll('.search-button');
        buttons.forEach(function(button) {
            button.addEventListener('click', function() {
                var depart = this.getAttribute('data-depart');
                var patientid = document.getElementById('patient_id').value;

                department_id = Number(depart);
                patient_id = Number(patientid);

                url = 'https://111c-14-36-58-174.ngrok-free.app/doctors/list/' + department_id + '?patient_id=' + patient_id;

                fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    // 응답받은 json 데이터를 get 방식으로 보내기 위한 과정
                    var queryParams = new URLSearchParams();
                    queryParams.append('json_data', JSON.stringify(data));
                    queryParams.append('patient', patient_id);
        
                    // window.location.href를 사용하여 새로운 페이지로 이동
                    window.location.href = '/doctors/doctor_list_page?' + queryParams.toString();
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
</html>
